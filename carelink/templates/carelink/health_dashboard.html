{% extends 'carelink/base.html' %}
{% load static %}
{% load carelink_extras %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Patient Information -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0">Patient Information</h5>
                </div>
                <div class="card-body text-center">
                    <h4 class="fw-bold">{{ patient.first_name }} {{ patient.last_name }}</h4>
                    <p class="text-muted">Patient ID: {{ patient.id }}</p>
                    <p><strong>Age:</strong> {{ patient.date_of_birth|timesince }} old</p>
                    <p><strong>Medical Condition:</strong> {{ patient.medical_condition }}</p>
                    <hr>
                    <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#reportModal">
                        <i class="fas fa-file-medical me-2"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Care Recommendations -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0 rounded-lg" id="recommendationsContainer">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI Care Recommendations</h5>
                    <button class="btn btn-light" onclick="downloadRecommendationsPDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
                <div class="card-body" id="recommendations-container">
                    <div class="text-center mb-4">
                        <h4>{{ patient.first_name }} {{ patient.last_name }}</h4>
                        <p class="text-muted">{{ patient.date_of_birth|date:"F d, Y" }}</p>
                    </div>
                    <div id="recommendationsList">
                        <p class="text-muted text-center">Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vital Signs Trends -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Vital Signs Trends</h5>
                    <div class="btn-group">
                        <button class="btn btn-light btn-sm" onclick="updateChart('week')">Week</button>
                        <button class="btn btn-light btn-sm" onclick="updateChart('month')">Month</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="vitalsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Analytics -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Health Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Blood Pressure Stability</h6>
                        <div class="progress" style="width: 60%;">
                            <div class="progress-bar" role="progressbar" data-metric="bp_stability" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Temperature Trend</h6>
                        <div class="progress" style="width: 60%;">
                            <div class="progress-bar bg-success" role="progressbar" data-metric="temp_stability" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>Overall Health Score</h6>
                        <div class="progress" style="width: 60%;">
                            <div class="progress-bar bg-warning" role="progressbar" data-metric="overall_score" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Recent Activities</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for activity in recent_activities %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">{{ activity.title }}</h6>
                                <p class="mb-0 text-muted">{{ activity.timestamp|date:"F d, Y H:i" }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center">No recent activities</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reportModalLabel">Generate Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select the type of report you want to generate:</p>
                <div class="d-grid gap-2">
                    <a class="btn btn-outline-primary" href="{% url 'carelink:generate_health_report' patient.id %}?type=daily">Daily Report</a>
                    <a class="btn btn-outline-primary" href="{% url 'carelink:generate_health_report' patient.id %}?type=weekly">Weekly Report</a>
                    <a class="btn btn-outline-primary" href="{% url 'carelink:generate_health_report' patient.id %}?type=monthly">Monthly Report</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
function fetchRecommendations() {
    const patientId = "{{ patient.id }}";
    fetch(`{% url 'carelink:get_ai_recommendations' patient.id %}`, {
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('recommendationsList');
            if (data.success) {
                const recommendations = data.recommendations;
                if (recommendations.length > 0) {
                    list.innerHTML = '';
                    recommendations.forEach(rec => {
                        const recDiv = document.createElement('div');
                        recDiv.className = 'recommendation-item mb-4';
                        recDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold text-primary">${rec.title}</h6>
                                    <p class="mb-1">${rec.description}</p>
                                    <small class="text-muted">Generated ${new Date().toLocaleDateString()}</small>
                                </div>
                            </div>
                        `;
                        list.appendChild(recDiv);
                    });
                } else {
                    list.innerHTML = '<p class="text-muted text-center">No recommendations available.</p>';
                }
            } else {
                list.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        ${data.error || 'Failed to fetch recommendations'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('recommendationsList').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    Failed to load recommendations. Please try again later.
                </div>
            `;
        });
}

function downloadRecommendationsPDF() {
    const element = document.getElementById('recommendationsContainer').cloneNode(true);
    
    // Clean up the element for PDF
    element.querySelectorAll('.btn').forEach(btn => btn.remove());
    
    // Add styling for PDF
    element.style.padding = '20px';
    element.style.maxWidth = '800px';
    element.style.margin = '0 auto';
    
    // Add header with patient info and date
    const header = document.createElement('div');
    header.style.textAlign = 'center';
    header.style.marginBottom = '20px';
    header.innerHTML = `
        <h2>Health Recommendations</h2>
        <h4>Patient: {{ patient.first_name }} {{ patient.last_name }}</h4>
        <p>Generated on: ${new Date().toLocaleDateString()}</p>
    `;
    element.insertBefore(header, element.firstChild);
    
    // Configure PDF options
    const opt = {
        margin: 1,
        filename: `recommendations_{{ patient.first_name }}_{{ patient.last_name }}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    // Generate PDF
    html2pdf().set(opt).from(element).save();
}

// Initialize vital signs chart
function initVitalsChart() {
    const ctx = document.getElementById('vitalsChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Blood Pressure',
                borderColor: 'rgb(255, 99, 132)',
                data: []
            }, {
                label: 'Temperature',
                borderColor: 'rgb(54, 162, 235)',
                data: []
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
    return chart;
}

function updateChart(period) {
    fetch(`{% url 'carelink:get_vitals_data' patient.id %}?period=${period}`, {
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            vitalsChart.data.labels = data.labels;
            vitalsChart.data.datasets[0].data = data.bp_data;
            vitalsChart.data.datasets[1].data = data.temp_data;
            vitalsChart.update();
        }
    })
    .catch(error => console.error('Error:', error));
}

function updateHealthMetrics() {
    fetch(`{% url 'carelink:get_health_metrics' patient.id %}`, {
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update Blood Pressure Stability
            const bpBar = document.querySelector('[data-metric="bp_stability"]');
            bpBar.style.width = `${data.bp_stability}%`;
            bpBar.setAttribute('aria-valuenow', data.bp_stability);
            
            // Update Temperature Stability
            const tempBar = document.querySelector('[data-metric="temp_stability"]');
            tempBar.style.width = `${data.temp_stability}%`;
            tempBar.setAttribute('aria-valuenow', data.temp_stability);
            
            // Update Overall Health Score
            const scoreBar = document.querySelector('[data-metric="overall_score"]');
            scoreBar.style.width = `${data.overall_score}%`;
            scoreBar.setAttribute('aria-valuenow', data.overall_score);
        }
    })
    .catch(error => console.error('Error:', error));
}

function updateRecentActivities() {
    fetch(`{% url 'carelink:get_recent_activities' patient.id %}`, {
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const timelineContainer = document.querySelector('.timeline');
            if (data.activities && data.activities.length > 0) {
                timelineContainer.innerHTML = data.activities.map(activity => `
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">${activity.title}</h6>
                            <p class="mb-0 text-muted">${new Date(activity.timestamp).toLocaleString()}</p>
                            ${activity.details ? `<small class="text-muted">${activity.details}</small>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                timelineContainer.innerHTML = '<p class="text-muted text-center">No recent activities</p>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.querySelector('.timeline').innerHTML = '<p class="text-muted text-center">Error loading activities</p>';
    });
}

let vitalsChart;
document.addEventListener('DOMContentLoaded', function() {
    vitalsChart = initVitalsChart();
    updateChart('week');
    fetchRecommendations();
    updateHealthMetrics();
    updateRecentActivities();
    // Update data every 5 minutes
    setInterval(() => {
        updateHealthMetrics();
        updateRecentActivities();
    }, 300000);
});
</script>

<style>
/* Recommendation styles */
.recommendation-item {
    border-left: 4px solid #007bff;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 0 8px 8px 0;
    transition: all 0.3s ease;
}

.recommendation-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Timeline styles */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007bff;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #007bff;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    bottom: -20px;
    width: 2px;
    background: #007bff;
}

.timeline-item:last-child:before {
    display: none;
}

/* Health Metrics styles */
.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    transition: width 0.6s ease;
}

/* Medication table styles */
.table th {
    border-top: none;
}

.table td {
    vertical-align: middle;
}

/* Print styles */
@media print {
    .btn-group, .btn {
        display: none !important;
    }
    
    .card {
        break-inside: avoid;
        margin-bottom: 20px;
    }
}
</style>
{% endblock %}
